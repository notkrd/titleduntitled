const discourse_colonialism = `from Discourse on Colonialism -  Aimé Césaire, 1955

First we must study how colonization works to decivilize the colonizer, to brutalize him in the true sense of the word, to degrade him, to awaken him to buried instincts, to covetousness, violence, race hatred, and moral relativism; and we must show that each time a head is cut off or an eye put out in Vietnam and in France they accept the fact, each time a little girl is raped and in France they accept the fact, each time a Madagascan is tortured and in France they accept the fact, civilization acquires another dead weight, a universal regression takes place, a gangrene sets in, a center of infection begins to spread; and that at the end of all these treaties that have been violated, all these lies that have been propagated, all these punitive expeditions that have been tolerated, all these prisoners who have been tied up and "interrogated," all these patriots who have been tortured, at the end of all the racial pride that has been encouraged, all the boastfulness that has been displayed, a poison has been distilled into the veins of Europe and, slowly but surely, the continent proceeds toward savagery.

And then one fine day the bourgeoisie is awakened by a terrific boomerang effect: the gestapos are busy, the prisons flll up, the torturers standing around the racks invent, refine, discuss...

For my part, I make a systematic defense of the non-European civilizations.
Every day that passes, every denial of justice, every beating by the police, every demand of the workers that is drowned in blood, every scandal that is hushed up, every punitive expedition, every police van, every gendarme and every militiaman, brings home to us the value of our old societies.
They were communal societies, never societies of the many
for the few.
They were societies that were not only ante-capitalist, as has been
said, but also anti-capitalist.
They were democratic societies, always.
They were cooperative societies, fraternal societies.
I make a systematic defense of the societies destroyed by
imperialism.
They were the fact, they did not pretend to be the idea; despite their faults, they were neither to be hated nor condemned. They were content to be. In them, neither the word failure nor the word avatar had any meaning. They kept hope intact.
Whereas those are the only words that can, in all honesry, be applied to the European enterprises outside Europe. My only consolation is that periods of colonization pass, that nations sleep only for a time, and that peoples remain.`

const uluru_statement = `Uluru Statement From the Heart - First Nations National Constitutional Convention
We, gathered at the 2017 National Constitutional Convention, coming from all points of the southern sky, make this statement from the heart:
Our Aboriginal and Torres Strait Islander tribes were the first sovereign Nations of the Australian continent and its adjacent islands, and possessed it under our own laws and customs.
This our ancestors did, according to the reckoning of our culture, from the Creation, according to the common law from ‘time immemorial’, and according to science more than 60,000 years
ago.
This sovereignty is a spiritual notion: the ancestral tie between the land, or ‘mother nature’, and the Aboriginal and Torres Strait Islander peoples who were born therefrom, remain
attached thereto, and must one day return thither to be united with our ancestors. This link is the basis of the ownership of the soil, or better, of sovereignty. It has never been ceded or
extinguished, and co-exists with the sovereignty of the Crown. 
How could it be otherwise? That peoples possessed a land for sixty millennia and this sacred link disappears from world history in merely the last two hundred years?
With substantive constitutional change and structural reform, we believe this ancient sovereignty can shine through as a fuller expression of Australia’s nationhood.
Proportionally, we are the most incarcerated people on the planet. We are not an innately criminal people. Our children are aliened from their families at unprecedented rates. This
cannot be because we have no love for them. And our youth languish in detention in obscene numbers. They should be our hope for the future.
These dimensions of our crisis tell plainly the structural nature of our problem. This is the torment of our powerlessness.
We seek constitutional reforms to empower our people and take a rightful place in our own country. When we have power over our destiny our children will flourish. They will walk in
two worlds and their culture will be a gift to their country.
We call for the establishment of a First Nations Voice enshrined in the Constitution.
Makarrata is the culmination of our agenda: the coming together after a struggle. It captures our aspirations for a fair and truthful relationship with the people of Australia and a better
future for our children based on justice and self-determination.
We seek a Makarrata Commission to supervise a process of agreement-making between governments and First Nations and truth-telling about our history.
In 1967 we were counted, in 2017 we seek to be heard. We leave base camp and start our trek across this vast country. We invite you to walk with us in a movement of the Australian people
for a better future.`

const aus_const =  `An Act to Constitute the Commonwealth of Australia - 9th July 1900

WHEREAS the people of New South Wales, Victoria, South Australia, Queensland, and Tasmania, humbly relying on the blessing of Almighty God, have agreed to unite in one indissoluble Federal Commonwealth under the Crown of the United Kingdom of Great Britain and Ireland, and under the Constitution hereby established:

And whereas it is expedient to provide for the admission into the Commonwealth of other Australasian Colonies and possessions of the Queen:

Be it therefore enacted by the Queen's most Excellent Majesty, by and with the advice and consent of the Lords Spiritual and Temporal, and Commons, in this present Parliament assembled, and by the authority of the same, as follows:

Short title
This Act may be cited as the Commonwealth of Australia Constitution Act.

Act to extend to the Queen's successors
The provisions of this Act referring to the Queen shall extend to Her Majesty's heirs and successors in the sovereignty of the United Kingdom.

Proclamation of Commonwealth
It shall be lawful for the Queen, with the advice of the Privy Council, to declare by proclamation that, on and after a day therein appointed, not being later than one year after the passing of this Act, the people of New South Wales, Victoria, South Australia, Queensland, and Tasmania, and also, if Her Majesty is satisfied that the people of Western Australia have agreed thereto, of Western Australia, shall be united in a Federal Commonwealth under the name of the Commonwealth of Australia. But the Queen may, at any time after the proclamation, appoint a Governor-General for the Commonwealth.

Commencement of Act
The Commonwealth shall be established, and the Constitution of the Commonwealth shall take effect, on and after the day so appointed. But the Parliaments of the several colonies may at any time after the passing of this Act make any such laws, to come into operation on the day so appointed, as they might have made if the Constitution had taken effect at the passing of this Act.

Operation of the Constitution and laws
This Act, and all laws made by the Parliament of the Commonwealth under the Constitution, shall be binding on the courts, judges, and people of every State and of every part of the Commonwealth, notwithstanding anything in the laws of any State; and the laws of the Commonwealth shall be in force on all British ships, the Queen's ships of war excepted, whose first port of clearance and whose port of destination are in the Commonwealth.`

const bureau_prisons = `from Title 18 of the US Code § 4042 - Duties of Bureau of Prisons, 1940 and contemporary

(a) In General.—The Bureau of Prisons, under the direction of the Attorney General, shall—
(1) have charge of the management and regulation of all Federal penal and correctional institutions;
(2) provide suitable quarters and provide for the safekeeping, care, and subsistence of all persons charged with or convicted of offenses against the United States, or held as witnesses or otherwise;
(3) provide for the protection, instruction, and discipline of all persons charged with or convicted of offenses against the United States;
(4) provide technical assistance to State, tribal, and local governments in the improvement of their correctional systems;
(5) provide notice of release of prisoners in accordance with subsections (b) and (c);
(6) establish prerelease planning procedures that help prisoners—
(A) apply for Federal and State benefits upon release (including Social Security benefits, and veterans’ benefits);
(B) obtain identification, including a social security card, driver’s license or other official photo identification, and a birth certificate; and
(C) secure such identification and benefits prior to release from a sentence to a term of imprisonment in a Federal prison or if the individual was not sentenced to a term of imprisonment in a Federal prison, prior to release from a sentence to a term of community confinement, subject to any limitations in law; and
(7) establish reentry planning procedures that include providing Federal prisoners with information in the following areas:
(A) Health and nutrition.
(B) Employment.
(C) Literacy and education.
(D) Personal finance and consumer skills.
(E) Community resources.
(F) Personal growth and development.
(G) Release requirements and procedures.
`

const prisons_obsolete = `from Are Prisons Obsolete - Angela Davis, 2003 

In most parts of the world, it is taken for granted that whoever is convicted of a serious crime will be sent to prison. In some countries-including the United States-where capital punishment has not yet been abolished, a small but significant number of people are sentenced to death for what are considered especially grave crimes. Many people are familiar with the campaign to abolish the death penalty. In fact, it has already been abolished in most countries. Even the staunchest advocates of capital punishment acknowledge the fact that the death penalty faces serious challenges. Few people find life without the death penalty difficult to imagine. 

On the other hand, the prison is considered an inevitable and permanent feature of our social lives. Most people are quite surprised to hear that the prison abolition movement also has a long history-one that dates back to the historical appearance of the prison as the main form of punishment. In fact, the most natural reaction is to assume that prison activists-even those who consciously refer to themselves as ”anti-prison activists”- are simply trying to ameliorate prison conditions or perhaps to reform the prison in more fundamental ways. In most circles prison abolition is simply unthinkable and implausible. Prison abolitionists are dismissed as utopians and idealists whose ideas are at best unrealistic and impracticable, and, at worst, mystifying and foolish. This is a measure of how difficult it is to envision a social order that does not rely on the threat of sequestering people in dreadful places designed to separate them from their communities and families. The prison is considered so ”natural” that it is extremely hard to imagine life without it.

It is my hope that this book will encourage readers to question their own assumptions about the prison. Many people have already reached the conclusion that the death penalty is an outmoded form of punishment that violates basic principles of human rights. It is time, I believe, to encourage similar conversations about the prison. During my own career as an anti-prison activist I have seen the population of U.S. prisons increase with such rapidity that many people in black, Latino, and Native American communities now have a far greater chance of going to prison than of getting a decent education. When many young people decide to join the military service in order to avoid the inevitability of a stint in prison, it should cause us to wonder whether we should not try to introduce better alternatives.`

const doct_discovery = `from Inter Caetera - Pope Alexander VI, 1493

Wherefore, as becomes Catholic kings and princes, after earnest consideration of all matters, especially of the rise and spread of the Catholic faith, as was the fashion of your ancestors, kings of renowned memory, you have purposed with the favor of divine clemency to bring under your sway the said mainlands and islands with their residents and inhabitants and to bring them to the Catholic faith. Hence, heartily commending in the Lord this your holy and praiseworthy purpose, and desirous that it be duly accomplished, and that the name of our Savior be carried into those regions, we exhort you very earnestly in the Lord and by your reception of holy baptism, whereby you are bound to our apostolic commands, and by the bowels of the mercy of our Lord Jesus Christ, enjoy strictly, that inasmuch as with eager zeal for the true faith you design to equip and despatch this expedition, you purpose also, as is your duty, to lead the peoples dwelling in those islands and countries to embrace the Christian religion; nor at any time let dangers or hardships deter you therefrom, with the stout hope and trust in your hearts that Almighty God will further your undertakings. And, in order that you may enter upon so great an undertaking with greater readiness and heartiness endowed with benefit of our apostolic favor, we, of our own accord, not at your instance nor the request of anyone else in your regard, but out of our own sole largess and certain knowledge and out of the fullness of our apostolic power, by the authority of Almighty God conferred upon us in blessed Peter and of the vicarship of Jesus Christ, which we hold on earth, do by tenor of these presents, should any of said islands have been found by your envoys and captains, give, grant, and assign to you and your heirs and successors, kings of Castile and Leon, forever, together with all their dominions, cities, camps, places, and villages, and all rights, jurisdictions, and appurtenances, all islands and mainlands found and to be found, discovered and to be discovered towards the west and south, by drawing and establishing a line from the Arctic pole, namely the north, to the Antarctic pole, namely the south, no matter whether the said mainlands and islands are found and to be found in the direction of India or towards any other quarter, the said line to be distant one hundred leagues towards the west and south from any of the islands commonly known as the Azores and Cape Verde...`

// With this proviso however that none of the islands and mainlands, found and to be found, discovered and to be discovered, beyond that said line towards the west and south, be in the actual possession of any Christian king or prince up to the birthday of our Lord Jesus Christ just past from which the present year one thousand four hundred ninety-three begins. And we make, appoint, and depute you and your said heirs and successors lords of them with full and free power, authority, and jurisdiction of every kind; with this proviso however, that by this our gift, grant, and assignment no right acquired by any Christian prince, who may be in actual possesssion of said islands and mainlands prior to the said birthday of our Lord Jesus Christ, is hereby to be understood to be withdrawn or taking away. Moreover we command you in virtue of holy obedience that, employing all due diligence in the premises, as you also promise—nor do we doubt your compliance therein in accordance with your loyalty and royal greatness of spirit—you should appoint to the aforesaid mainlands and islands worthy, God-fearing, learned, skilled, and expeienced men, in order to instruct the aforesaid inhabitants and residents in the Catholic faith and train them in good morals. Furthermore, under penalty of excommunication "late sententie" to be incurred "ipso facto," should anyone thus contravene, we strictly forbid all persons of whatsoever rank, even imperial and royal, or of whatsoever estate, degree, order, or condition, to dare without your special permit or that of your aforesaid heirs and successors, to go for the purpose of trade or any other reason to the islands or mainlands, found and to be found, discovered and to be discovered, towards the west and south, by drawing and establishing a line from the Arctic pole to the Antarctic pole, no matter whether the mainlands and islands, found and to be found, lie in the direction of India or toward any other quarter whatsoever, the said line to be distant one hundred leagues towards the west and south, as is aforesaid, from any of the islands commonly known as the Azores and Cape Verde; apostolic constitutions and ordinances and other decrees whatsoever to the contrary notwithstanding. We trust in Him from whom empires and governments and all good things proceed, that, should you, with the Lord’s guidance, pursue this holy and praiseworthy undertaking, in a short while your hardships and endeavors will attain the most felicitious result, to the happiness and glory of all Christendom.
// `

const the_421st = `-*-

Zapatista Maritime Delegation - SupGaleano, 2021

The calendar? An early morning in April. Geography? The mountains of the Mexican Southeast. A sudden silence overtakes the crickets, the distant barking of dogs, and the echo of marimba music. Here, in the belly of the mountains, it sounds more like a whisper than a shout. If we weren’t where we are, you might think it was the murmur of the open ocean. But it’s not the sound of waves crashing against the coast, the beach, or the cliff edge marked by a sheer drop. No, it’s something more than that. And then… a long wail and a sudden, brief tremor...

“So it was written,” says Old Man Antonio as he sharpens his double-edged machete, and Doña Juanita nods and sighs. The fire smells like coffee and cooked corn. A cumbia is playing on the community radio. The lyrics speak of an impossible legend: a mountain traversing history against the grain.

-*-

Seven people, seven Zapatistas, will make up the maritime division of our delegation to Europe. Four men, two women, and one other (unoa otroa). 4, 2, 1. The 421st Squadron is already stationed at the “Zapatistas Maritime-Land Training Center” located in the Comandanta Ramona Seedbed in the Tzotz Choj zone.
... 
The four women, two men and one other are human beings. They were given the Turing Test, with a few modifications I considered pertinent, to discard the possibility that any of them, or all of them, might be a cybernetic organism, a robot that is, capable of dancing the cumbia del Sapito[i] with a few missteps. Therefore, the seven of them belong to the human race.
...

-*-
Thus, our first footstep on European soil (assuming of course they even let us disembark) will not be that of a man, nor that of a woman, but that of an other [otroa]. In what the late SupMarcos would have called a “slap in the face of the hetero-patriarchal left,” it has been decided that the first person to disembark will be Marijose. Upon stepping for the first time on European soil and recovering from seasickness, Marijose will shout:

“Surrender hetero-patriarchal pale-faces who persecute those who are different!”

Nah, just kidding, but that would be cool wouldn’t it?

Rather, upon landing, the Zapatista compa Marijose will solemnly say:

“In the name of the Zapatista women, children, men, elderly, and of course, others, I declare that from now on this place, currently referred to as “Europe” by those who live here, be called: SLUMIL K´AJXEMK´OP, which means “Rebellious Land” or “Land which does not give in nor give up.” And that is how it will be known by its own people and by others for as long as there is at least someone here who does not surrender, sell out, or give up.

-*-`

// The calendar? An early morning in April. Geography? The mountains of the Mexican Southeast. A sudden silence overtakes the crickets, the distant barking of dogs, and the echo of marimba music. Here, in the belly of the mountains, it sounds more like a whisper than a shout. If we weren’t where we are, you might think it was the murmur of the open ocean. But it’s not the sound of waves crashing against the coast, the beach, or the cliff edge marked by a sheer drop. No, it’s something more than that. And then… a long wail and a sudden, brief tremor.

// The mountain gets up, shyly lifting its skirts a bit and, not without some difficulty, pulls its feet out of the earth. It takes a first step, grimacing in pain. Far from maps, tourist destinations and catastrophes, the soles of the small mountain’s feet are bleeding. But here all are in on the plan, so an unexpected rain falls to wash its feet and cure its wounds.

// “Take care, daughter,” says the mother Ceiba tree. “You can do it!” says the Huapác tree, as if to itself. The paraque bird leads the way. “Go east, friend, go east,” it says as it hops from side to side. Clothed in trees, birds, and stones, the mountain walks, and with each step, sleepy men, women, persons who are neither men nor women, and boys and girls grab onto her skirts. They climb up her blouse, crown the tip of her breasts, continue up her shoulders, and, when they have reached the top of her head, they awaken.

// To the east, the sun, just edging above the horizon, slows its stubborn daily rise. It’s quite a sight to see a mountain, with a crown of humans, walking along. But besides the sun and a few gray clouds that the night left behind, no one here seems surprised.

// All seven of them were born on the continent called “America” and the fact that they share pain and rage with other originary peoples from this side of the ocean makes them Latin Americans. They are also Mexicans, descended from originary Mayan peoples, as confirmed by their families, neighbors and acquaintances. They are also Zapatistas, with documents from the autonomous municipalities and the Good Government Councils that show as much. They have not been shown to have committed any crimes that were not appropriately punished. They live, work, get sick, get well, fall in love, fall out of love, laugh, cry, remember, forget, play, get serious, take notes, make up excuses—that is, they live, in the mountains of Southeastern Mexico, in Chiapas, Mexico, Latin America, America, Planet Earth, etcetera.

const assimilation_proclamation = `Benevolent Assimilation Proclamation - William McKinley, 1898

In performing this duty the military commander of the United States is enjoined to make known to the inhabitants of the Philippine Islands that in succeeding to the sovereignity of Spain, in severing the former political relations, and in establishing a new political power, the authority of the United States is to be exerted for the securing of the persons and property of the people of the islands and for the confirmation of all their private rights and relations. It will be the duty of the commander of the forces of occupation to announce and proclaim in the most public manner that we come, not as invaders or conquerors, but as friends, to protect the natives in their homes, in their employments, and in their personal and religious rights. All persons who, either by active aid or by honest submission, co-operate with the Government of the United States to give effect to these beneficent purposes will receive the reward of its support and protection. All others will be brought within the lawful rule we have assumed, with firmness if need be, but without severity, so far as possible... 

Finally, it should be the earnest wish and paramount aim of the military administration to win the confidence, respect, and affection of the inhabitants of the Philippines by assuring them in every possible way that full measure of individual rights and liberties which is the heritage of free peoples, and by proving to them that the mission of the United States is one of 
BENEVOLENT ASSIMILATION 
substituting the mild sway of justice and right for arbitrary rule. In the fulfillment of this high mission, supporting the temperate administration of affairs for the greatest good of the governed, there must be sedulously maintained the strong arm of authority, to repress disturbance and to overcome all obstacles to the bestowal of the blessings of good and stable government upon the people of the Philippine Islands under the free flag of the United States.

WILLIAM McKINLEY. `

const text_pairings = {
    "DISCOVERY": {
        "canon": "The Papal Bull \"Inter Caetera\"",
        "counter": "421st SQUADRON (Zapatista Maritime Delegation)",
        "description": "The papal bull Inter Caetera was issued by Pope Alexander VI in 1493, granting official religious legitimacy to the Spanish and Portuguese genocidal conquests of the Americas, denying the sovereignty and humanity of Indigenous societies. It was only repudiated in April 2023, in the wake of Indigenous organizing and the unearthing of mass graves in Canadian residential schools. Under various pen names but with consistent poetic force and subtlety, the writings of the Zapista movement from Chiapas, Mexico and led by Mayan and other First Peoples in global encounters offer theories and practices of survival and resistance, gaining global attention after their uprising in 1994, their key role in the Global Justice Movement against neoliberal globalisation, and their subsequent demonstration of models of autonomous governance, making famous calls for \"a world of many worlds\". This text was issued before a listening and speaking tour in Europe by 170 Zapatistas 500 years after Hernan Cortez' invasion, plotting rebellious solidarity rather than formal statements of apology. The Sixth Declaration of the Lacondon Jungle more directly introduces Zapatista histories and theories of resistance.",
        "canon_text": doct_discovery,
        "counter_text": the_421st
    },
    "LAW": {
        "canon": "Title 18 of the US Code § 4042 - Duties of Bureau of Prisons",
        "counter": "Are Prisons Obsolete?",
        "description": "The US criminal code describes aims and regulations of the federal prison system, which along with its state counterparts confine over 1.2 million people. The philosopher, scholar, and activist Angela Davis articulated the role of the American prison industrial complex in exploitation and social control, the expansion of women's prisons, `SuperMax` prisons, and wholesale or partial prison privatization. Davis's work ignites research and action towards systems of safety not built around cages, including through Davis' and many others work in the prison abolition organization Critical Resistance.",
        "canon_text": bureau_prisons,
        "counter_text": prisons_obsolete
    },
    "NATION": {
        "canon": "Constitution of Australia",
        "counter": "Uluru Statement from the Heart",
        "description": "Australia's foundation and founding documents, like that of the other settler colonies, was established in denial of the governance structures of First Nations in the territories that are claimed, in the Australian Constitution, for the British Crown and Christian God: in Australia's case through genocide perpetrated against Aboriginal and Torres Strait cultures with continuity 'according to the common law from 'time immemorial', and according to science [from] more than 60,000 years ago'. The Uluru Statement from the Heart makes calls for truth-telling, political representation, and structural changes. While Accompanying a national legal process with a referendum to occur late in 2023, the Uluru Statement from the Heart speaks with words that may cut through this formal context.",
        "canon_text": aus_const,
        "counter_text": uluru_statement
    },
    "POSSESSION": {
        "canon": "The Benevolent Assimilation Proclamation",
        "counter": "A Discourse on Colonialism",
        "description": "The Benevolent Assimilation Proclamation, issued by US President William McKinley in 1898 following the American occupation of the Phillipines, attempted to somehow explain the overthrow and anexation of the Phillipine Republic as consistent with proclaimed American ideals - paralleling the pretence by many colonial powers that violent and extractive occupations were driven by humanitarian concern, or a racial 'civilizing mission'. The Martinican and French poet and politician Aimé Césaire's devestating Discourse on Colonialism exposes the and effaced violence in such claims to civilizational superiority by French, European, and other colonial powers, and articulates the harmful 'decivilizing' effects of colonialism on the colonizer as well as the colonized.",
        "canon_text": assimilation_proclamation,
        "counter_text": discourse_colonialism
    }
    
}

const time_pairing = (curr_minutes) => Object.keys(text_pairings)[Math.floor(curr_minutes/60 * Object.keys(text_pairings).length)]

const getId = (an_id) => document.getElementById(an_id)

const the_canon = getId("canon")
const the_counter = getId("counter")
const the_composition = getId("composition")
const new_words = getId("newWords")
const old_words = getId("oldWords")
const new_syntax = getId("newSyntax")
const text_names = getId("textNames")
const next_text = getId("nextText")
const on_texts = getId("onTexts")
const pair_select = getId("pairings")

const rand_elt = (an_array) => an_array[Math.floor(Math.random() * an_array.length)]
const rand_word = (all_words) => rand_elt(all_words).toLowerCase()


let curr_pairing;
let canon_text;
let counter_text;
let the_syntax = [["noun","verb"],["adjective", "noun", "verb","noun"]]
let UPDATE_INTERVAL = 5000
let NUM_LINES = 48
let CONTINUATION_CHANCE = 0.75
let canon_nouns;
let canon_adjectives;
let canon_verbs;
let counter_nouns;
let counter_verbs;
let counter_adjectives;
let sent_progression;
let date_time;

let start_time = new Date ();
let start_mins = start_time.getMinutes();

let current_lines = [];
let lines_cats = [];
let pinText = false;

function display_text(a_text, a_page=the_palimpsest) {
    a_page.innerText = a_text;
}

function rand_of_kind(a_kind, from_nouns, from_verbs, from_adjectives) {
    switch(a_kind.toLowerCase()) {
        case "noun": return rand_word(from_nouns);
        case "verb": return rand_word(from_verbs);
        case "adjective": return rand_word(from_adjectives);
        default: return "";
    }
}

function random_sentence(from_nouns, from_verbs, from_adjectives, pattern = ["noun", "verb", "adjective", "noun"]) {
    the_sent = []
    for(let i = 0; i < pattern.length; i++) {
        the_sent.push(rand_of_kind(pattern[i], from_nouns, from_verbs, from_adjectives))
    }
    return the_sent
}

function random_followup(from_nouns, from_verbs, from_adjectives, pattern = ["noun", "verb", "adjective", "noun"], prev_sent = [], prev_cats = [])
{
    let common_cat_indices = pattern.reduce((acc, val, i) => prev_cats.includes(val) ? acc.concat([i]) : acc, [])
    if (common_cat_indices.length > 0 && Math.random() < CONTINUATION_CHANCE) {
        const randomIndex = Math.floor(Math.random() * common_cat_indices.length);
        let sentence = []
        for(let i = 0; i < pattern.length; i++){
            if (i === randomIndex) {
                sentence.push(prev_sent[i])
            }
            else {
                sentence.push(rand_of_kind(pattern[i], from_nouns, from_verbs, from_adjectives))
            }
        }
        return sentence
    }
    else {
        return random_sentence(from_nouns, from_verbs, from_adjectives, pattern)
    }
}

function display_lines(lines) {
    display_text(lines.reduce((t,x) => t + `
    ` + x.join(" "), ""), the_composition)
}

function updateMenu(the_menu, the_options, num_options, kind) {
    the_menu.innerHTML = '';
    const new_options = [...Array(num_options).keys()].map(_ => rand_word(the_options))
    function word_anchor(a_word, a_number) {
        newA = document.createElement("a");
        theWord = document.createTextNode(a_word);
        newA.appendChild(theWord);
        newA.id = kind+a_number;
        newA.id;
        newA.href = `javascript:${kind}("${a_word}")`;
        return newA;
    }
    new_options.forEach((a_word, i) => {
        let an_anchor = word_anchor(a_word, i);
        the_menu.appendChild(an_anchor);
    })
}

function escapeRegExp(text) {
    return text.replace(/[-[\]{}()*+?.,\\^$|#\s`"]/g, '\\$&');
}

function formatPhrase(the_phrase, the_tag, the_element) {
    let the_html = the_element.innerHTML
    let new_text =  the_html.replaceAll(new RegExp(escapeRegExp(the_phrase), "ig"), (s) => `<${the_tag}>${s}</${the_tag}>`)
    the_element.innerHTML = new_text
    return new_text
}

function newWord(a_word){
    canon_nouns.push(a_word)
    updateMenu(new_words, counter_nouns, 5, "newWord")
    counter_text = formatPhrase(a_word, "b",the_counter)
}
function oldWord(a_word){
    const index = canon_nouns.indexOf(a_word);
    if (index > -1) {
        canon_nouns.splice(index, 1);
    }
    updateMenu(old_words, canon_nouns, 5, "oldWord")
    canon_text = formatPhrase(a_word, "s",the_canon)
}

let new_proposal = new Array();
const learnbtn = document.getElementById("learnSyntax");

function addCat(a_cat){
    new_proposal.push(a_cat);
    learnbtn.innerText = "LEARN: " + new_proposal.join(" ");
}

function resetSyntax(){
    new_proposal = [];
    learnbtn.innerText = "LEARN: " + new_proposal.join(" ");
}

function learnSyntax(){
    if(!the_syntax.includes(new_proposal)){
        the_syntax.push(new_proposal)
    }
    resetSyntax()
}

function pairing_title(a_pairing) {
    return `${a_pairing}: ${text_pairings[a_pairing]["canon"]} / ${text_pairings[a_pairing]["counter"]}`
}

function loadTexts(a_pairing) {
    curr_pairing = a_pairing
    canon_text = text_pairings[a_pairing]["canon_text"]
    counter_text = text_pairings[a_pairing]["counter_text"]
    
    canon_nouns = nlp(text_pairings[a_pairing]["canon_text"]).nouns().normalize().toSingular().json().map((w)=>w["text"])
    canon_verbs = nlp(text_pairings[a_pairing]["canon_text"]).verbs().normalize().toPresentTense().json().map((w)=>w["text"])
    canon_adjectives = nlp(text_pairings[a_pairing]["canon_text"]).adjectives().normalize().json().map((w)=>w["text"])
    counter_nouns = nlp(text_pairings[a_pairing]["counter_text"]).nouns().normalize().toSingular().normalize().json().map((w)=>w["text"])
    counter_verbs = nlp(text_pairings[a_pairing]["counter_text"]).verbs().normalize().toPresentTense().normalize().json().map((w)=>w["text"])
    counter_adjectives = nlp(text_pairings[a_pairing]["counter_text"]).adjectives().normalize().json().map((w)=>w["text"])
    
    text_names.innerText = pairing_title(a_pairing)
    
    on_texts.innerText = `ON THESE TEXTS: ${text_pairings[a_pairing]["description"]}`
    display_text(canon_text, the_canon)
    display_text(counter_text, the_counter)
    display_text(the_composition, "")
    updateMenu(new_words, counter_nouns, 5, "newWord")
    updateMenu(old_words, canon_nouns, 5, "oldWord")
    
    for (let i = 0; i < NUM_LINES; i++) {
        let the_cats = rand_elt(the_syntax)
        lines_cats [i] = the_cats
        if (i > 0) {
            current_lines[i] = random_followup(canon_nouns, canon_verbs, canon_adjectives, the_cats, current_lines[i-1], lines_cats[i-1])
        }
        else{
            current_lines[i] = random_sentence(canon_nouns, canon_verbs, canon_adjectives, the_cats)
        }
    }
    
    sent_progression = window.setInterval(function(){
        let the_cats = rand_elt(the_syntax)
        current_lines.pop()
        lines_cats.pop()
        current_lines.unshift(random_followup(canon_nouns, canon_verbs, canon_adjectives, the_cats, current_lines[0], lines_cats[0]))
        lines_cats.unshift(the_cats)
        display_lines(current_lines)
        let d = new Date ();
        let mins = (d.getMinutes() - start_mins) % 60;
        if (time_pairing(mins) !== curr_pairing && !pinText) {
            loadTexts(time_pairing(mins))
        }
        next_text.innerText = "Next - " + pairing_title(time_pairing((mins + 20) % 60)) + ` in ${(19-mins) % 20} minutes`
        
    }, UPDATE_INTERVAL)
}

// const a_text = [...Array(10).keys()].reduce((t,x) => t + `
// ` + random_sentence(canon_nouns, canon_verbs, canon_adjectives), "")
// const b_text = [...Array(10).keys()].reduce((t,x) => t + `
// ` + random_sentence(counter_nouns, counter_verbs, counter_adjectives), "")

Object.entries(text_pairings).forEach(p => {
    newOpt = document.createElement("Option")
    newOpt.innerText = p[0]
    newOpt.setAttribute("value", p[0])
    pair_select.appendChild(newOpt)
})

pair_select.addEventListener("change", (event) => {
    loadTexts(event.target.value)
    pinText = true;
})

loadTexts("DISCOVERY")

// Collapsible notes

var coll = document.getElementsByClassName("collapsible");
var i;

for (i = 0; i < coll.length; i++) {
    coll[i].addEventListener("click", function() {
        this.classList.toggle("active");
        var content = this.nextElementSibling;
        if (content.style.display === "block") {
            content.style.display = "none";
        } else {
            content.style.display = "block";
        }
    });
} 